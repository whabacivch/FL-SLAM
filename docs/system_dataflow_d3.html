<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golden Child SLAM v2 - System Dataflow</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #0a0a0a;
            color: #ffffff;
            font-family: Arial, sans-serif;
            overflow: auto;
        }
        #diagram {
            background-color: #0a0a0a;
        }
        .cluster {
            fill: none;
            stroke-width: 2;
        }
        .node {
            cursor: pointer;
        }
        .node:hover {
            opacity: 0.8;
        }
        .edge {
            fill: none;
            stroke-width: 1.2;
        }
        .edge-label {
            font-size: 8px;
            fill: #aaa;
        }
        .cluster-label {
            font-size: 11px;
            fill: #cccccc;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1 style="text-align: center; color: #ffffff;">Golden Child SLAM v2 - System Dataflow</h1>
    <div id="diagram"></div>

    <script>
        const width = 2500;
        const height = 2200;
        const margin = { top: 50, right: 50, bottom: 50, left: 50 };

        const svg = d3.select("#diagram")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .style("background-color", "#0a0a0a");

        // Zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 3])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });
        svg.call(zoom);

        const g = svg.append("g");

        // Helper function to create rounded rectangle
        function roundedRect(x, y, w, h, r) {
            return `M ${x},${y} L ${x+w-r},${y} Q ${x+w},${y} ${x+w},${y+r} L ${x+w},${y+h-r} Q ${x+w},${y+h} ${x+w-r},${y+h} L ${x+r},${y+h} Q ${x},${y+h} ${x},${y+h-r} L ${x},${y+r} Q ${x},${y} ${x+r},${y} Z`;
        }

        // Define all clusters with exact positions
        const clusters = [
            {
                id: "rosbag",
                label: "ðŸ“¦ Rosbag Source (M3DGR Dynamic01)",
                x: 200, y: 50,
                width: 2100, height: 120,
                fill: "#1a1a1a",
                stroke: "#555555"
            },
            {
                id: "hub",
                label: "ðŸ”§ gc_sensor_hub (Single Process)",
                x: 200, y: 200,
                width: 1800, height: 100,  // WIDER for spacing
                fill: "#1a1a1a",
                stroke: "#555555"
            },
            {
                id: "canon",
                label: "ðŸ“¡ Canonical Topics (/gc/sensors/*)",
                x: 500, y: 330,
                width: 1200, height: 100,
                fill: "#0f2a0f",
                stroke: "#33aa33"
            },
            {
                id: "state",
                label: "ðŸ’¾ State Storage",
                x: 200, y: 1650,
                width: 1400, height: 120,
                fill: "#0a0a1a",
                stroke: "#444466"
            },
            {
                id: "imu_buf",
                label: "ðŸ“¥ IMU Buffer",
                x: 1800, y: 460,
                width: 300, height: 100,
                fill: "#0a1a0a",
                stroke: "#336633"
            },
            {
                id: "pipeline",
                label: "ðŸ§  gc_backend_node - Pipeline (14 Steps Ã— 8 Hypotheses)",
                x: 50, y: 460,
                width: 1600, height: 1100,
                fill: "#1a1a2a",
                stroke: "#666666"
            },
            {
                id: "preproc",
                label: "Preprocessing",
                x: 100, y: 500,
                width: 200, height: 300,
                fill: "#1a2a1a",
                stroke: "#44aa44"
            },
            {
                id: "binning",
                label: "Binning & Pose Estimation",
                x: 350, y: 500,
                width: 400, height: 500,
                fill: "#1a2a1a",
                stroke: "#44aa44"
            },
            {
                id: "evidence",
                label: "Evidence Generation (Parallel)",
                x: 800, y: 850,
                width: 600, height: 200,
                fill: "#1a2a3a",
                stroke: "#4488aa"
            },
            {
                id: "fusion",
                label: "Fusion & State Update",
                x: 100, y: 1100,
                width: 600, height: 400,
                fill: "#1a2a1a",
                stroke: "#44aa44"
            },
            {
                id: "hypo",
                label: "ðŸ”„ Hypothesis Barycenter",
                x: 750, y: 1550,
                width: 400, height: 80,
                fill: "#2a1a1a",
                stroke: "#aa4444"
            },
            {
                id: "out",
                label: "ðŸ“¤ Outputs",
                x: 1800, y: 1650,
                width: 500, height: 300,
                fill: "#0a1a2a",
                stroke: "#444466"
            },
            {
                id: "audit",
                label: "ðŸ“Š Audit",
                x: 1800, y: 2000,
                width: 300, height: 100,
                fill: "#1a0a2a",
                stroke: "#aa00aa"
            },
            {
                id: "legend",
                label: "Legend",
                x: 1800, y: 600,
                width: 400, height: 400,
                fill: "#111111",
                stroke: "#333333"
            }
        ];

        // Draw clusters
        clusters.forEach(cluster => {
            const clusterGroup = g.append("g").attr("class", "cluster");
            
            clusterGroup.append("path")
                .attr("d", roundedRect(cluster.x, cluster.y, cluster.width, cluster.height, 10))
                .attr("fill", cluster.fill)
                .attr("stroke", cluster.stroke)
                .attr("stroke-width", 2);
            
            clusterGroup.append("text")
                .attr("x", cluster.x + cluster.width / 2)
                .attr("y", cluster.y + 20)
                .attr("text-anchor", "middle")
                .attr("class", "cluster-label")
                .text(cluster.label);
        });

        // Define all nodes with exact positions
        const nodes = [
            // Rosbag nodes (centered, evenly spaced)
            { id: "BAG_VRPN", label: "/vrpn_client_node/UGV/pose\n(Ground Truth)", x: 400, y: 100, width: 180, height: 50, fill: "#2a0e0e", stroke: "#ff4444", strokeDasharray: "5,5", textColor: "#ffcccc" },
            { id: "BAG_CAM_IMU", label: "/camera/imu", x: 620, y: 100, width: 140, height: 50, fill: "#2a0e0e", stroke: "#ff4444", strokeDasharray: "5,5", textColor: "#ffcccc" },
            { id: "BAG_CAM_COLOR", label: "/camera/color/image_raw/compressed", x: 800, y: 100, width: 280, height: 50, fill: "#2a0e0e", stroke: "#ff4444", strokeDasharray: "5,5", textColor: "#ffcccc" },
            { id: "BAG_CAM_DEPTH", label: "/camera/aligned_depth_to_color/image_raw/compressedDepth", x: 1120, y: 100, width: 380, height: 50, fill: "#2a0e0e", stroke: "#ff4444", strokeDasharray: "5,5", textColor: "#ffcccc" },
            { id: "BAG_AVIA_LIDAR", label: "/livox/avia/lidar", x: 1540, y: 100, width: 160, height: 50, fill: "#2a0e0e", stroke: "#ff4444", strokeDasharray: "5,5", textColor: "#ffcccc" },
            { id: "BAG_AVIA_IMU", label: "/livox/avia/imu", x: 1740, y: 100, width: 140, height: 50, fill: "#2a0e0e", stroke: "#ff4444", strokeDasharray: "5,5", textColor: "#ffcccc" },
            { id: "BAG_ODOM", label: "/odom\nOdometry\n(1 Hz)", x: 1920, y: 100, width: 140, height: 50, fill: "#0f3d0f", stroke: "#00ff00", textColor: "#ffffff" },
            { id: "BAG_MID_LIDAR", label: "/livox/mid360/lidar\nCustomMsg\n(10 Hz)", x: 2100, y: 100, width: 180, height: 50, fill: "#0f3d0f", stroke: "#00ff00", textColor: "#ffffff" },
            { id: "BAG_MID_IMU", label: "/livox/mid360/imu\nImu\n(200 Hz)", x: 2320, y: 100, width: 160, height: 50, fill: "#0f3d0f", stroke: "#00ff00", textColor: "#ffffff" },
            
            // Sensor Hub nodes (WIDE spacing - triple)
            { id: "ODOM_NORM", label: "odom_normalizer\nFrame: odom_combined â†’ base_footprint", x: 300, y: 250, width: 280, height: 60, fill: "#0f3d0f", stroke: "#00ff00", textColor: "#ffffff" },
            { id: "LIVOX_CONV", label: "livox_converter\nCustomMsg â†’ PointCloud2", x: 750, y: 250, width: 240, height: 60, fill: "#0f3d0f", stroke: "#00ff00", textColor: "#ffffff" },
            { id: "IMU_NORM", label: "imu_normalizer\nFrame: livox_frame", x: 1200, y: 250, width: 200, height: 60, fill: "#0f3d0f", stroke: "#00ff00", textColor: "#ffffff" },
            { id: "DEAD_AUDIT", label: "dead_end_audit\nTracks unused topics", x: 1550, y: 250, width: 200, height: 60, fill: "#2d004d", stroke: "#aa00aa", textColor: "#ffffff" },
            
            // Canonical topics
            { id: "CAN_ODOM", label: "/gc/sensors/odom\nnav_msgs/Odometry", x: 600, y: 380, width: 200, height: 50, fill: "#0f3d0f", stroke: "#00ff00", textColor: "#ffffff" },
            { id: "CAN_LIDAR", label: "/gc/sensors/lidar_points\nsensor_msgs/PointCloud2", x: 900, y: 380, width: 250, height: 50, fill: "#0f3d0f", stroke: "#00ff00", textColor: "#ffffff" },
            { id: "CAN_IMU", label: "/gc/sensors/imu\nsensor_msgs/Imu", x: 1250, y: 380, width: 180, height: 50, fill: "#0f3d0f", stroke: "#00ff00", textColor: "#ffffff" },
            { id: "CAN_DEAD", label: "/gc/dead_end_status\nJSON", x: 1500, y: 380, width: 180, height: 50, fill: "#2d004d", stroke: "#aa00aa", textColor: "#ffffff" },
            
            // IMU Buffer
            { id: "IMU_BUF", label: "IMU Buffer\n(stamp, gyro, accel)\nMax: 200 msgs\nUsed for: Deskew + Evidence", x: 1850, y: 500, width: 220, height: 80, fill: "#1e3e1e", stroke: "#66aa66", textColor: "#ffffff" },
            
            // Pipeline nodes - Preprocessing
            { id: "S01", label: "S01: PointBudgetResample\nMax: 8192 points\n(Closed-form)", x: 120, y: 550, width: 160, height: 70, fill: "#2a4a2a", stroke: "#00ff00", textColor: "#ffffff" },
            { id: "S02", label: "S02: PredictDiffusion\nUses: Q, dt, belief_prev\n(Closed-form)", x: 120, y: 650, width: 160, height: 70, fill: "#2a4a2a", stroke: "#00ff00", textColor: "#ffffff" },
            { id: "S03", label: "S03: DeskewConstantTwist\nUses: IMU preintegration\n(Approximate)", x: 120, y: 750, width: 160, height: 70, fill: "#4a3a1a", stroke: "#ff8800", textColor: "#ffffff" },
            
            // Pipeline nodes - Binning
            { id: "S04", label: "S04: BinSoftAssign\nÏ„=0.1, 48 bins\n(Closed-form)", x: 370, y: 550, width: 160, height: 70, fill: "#2a4a2a", stroke: "#00ff00", textColor: "#ffffff" },
            { id: "S05", label: "S05: ScanBinMomentMatch\nUses: map_stats, bucket_noise\n(Closed-form)", x: 370, y: 650, width: 160, height: 70, fill: "#2a4a2a", stroke: "#00ff00", textColor: "#ffffff" },
            { id: "S06", label: "S06: KappaFromResultant\nÎº_map, Îº_scan\n(Closed-form)", x: 370, y: 750, width: 160, height: 70, fill: "#2a4a2a", stroke: "#00ff00", textColor: "#ffffff" },
            { id: "S07", label: "S07: WahbaSVD\nRotation RÌ‚\n(Closed-form)", x: 370, y: 850, width: 160, height: 70, fill: "#2a4a2a", stroke: "#00ff00", textColor: "#ffffff" },
            { id: "S08", label: "S08: TranslationWLS\nTranslation tÌ‚\n(Closed-form)", x: 370, y: 950, width: 160, height: 70, fill: "#2a4a2a", stroke: "#00ff00", textColor: "#ffffff" },
            
            // Evidence nodes (parallel)
            { id: "S09A", label: "S09a: OdomQuadraticEvidence\nGaussian SE(3) pose\n(Closed-form)", x: 850, y: 900, width: 140, height: 80, fill: "#2a4a6a", stroke: "#00ccff", textColor: "#ffffff" },
            { id: "S09B", label: "S09b: ImuVMFGravityEvidence\nvMF on SÂ²\n(Laplace approx)", x: 1020, y: 900, width: 140, height: 80, fill: "#4a3a1a", stroke: "#ff8800", textColor: "#ffffff" },
            { id: "S09C", label: "S09c: ImuGyroRotationEvidence\nGaussian SO(3)\n(Closed-form)", x: 1190, y: 900, width: 140, height: 80, fill: "#2a4a6a", stroke: "#00ccff", textColor: "#ffffff" },
            { id: "S09D", label: "S09d: LidarQuadraticEvidence\nPose information\n(Closed-form)", x: 1360, y: 900, width: 140, height: 80, fill: "#2a4a6a", stroke: "#00ccff", textColor: "#ffffff" },
            
            // Fusion nodes
            { id: "S10", label: "S10: FusionScaleFromCertificates\nExcitation scaling\n(Approximate)", x: 120, y: 1150, width: 160, height: 70, fill: "#4a3a1a", stroke: "#ff8800", textColor: "#ffffff" },
            { id: "S11", label: "S11: InfoFusionAdditive\nL = L_prior + L_evidence\n(Closed-form)", x: 120, y: 1250, width: 160, height: 70, fill: "#2a4a2a", stroke: "#00ff00", textColor: "#ffffff" },
            { id: "S12", label: "S12: PoseUpdateFrobeniusRecompose\nFrobenius correction\n(Approximate)", x: 120, y: 1350, width: 160, height: 70, fill: "#4a3a1a", stroke: "#ff8800", textColor: "#ffffff" },
            { id: "S13", label: "S13: PoseCovInflationPushforward\nMap update\n(Closed-form)", x: 120, y: 1450, width: 160, height: 70, fill: "#2a4a2a", stroke: "#00ff00", textColor: "#ffffff" },
            { id: "S14", label: "S14: AnchorDriftUpdate\nAnchor maintenance\n(Closed-form)", x: 120, y: 1550, width: 160, height: 70, fill: "#2a4a2a", stroke: "#00ff00", textColor: "#ffffff" },
            
            // Hypothesis merge
            { id: "S15", label: "S15: HypothesisBarycenter\n8 Hypotheses â†’ 1 Belief\n(Closed-form)", x: 800, y: 1590, width: 300, height: 60, fill: "#4a2a2a", stroke: "#ff6666", textColor: "#ffffff" },
            
            // State storage
            { id: "ST_BELIEF", label: "BeliefGaussianInfo\n22D Ã— 8 Hypotheses\n(Info form: L, h)", x: 250, y: 1700, width: 220, height: 80, fill: "#1e1e2e", stroke: "#6666aa", textColor: "#ffffff" },
            { id: "ST_MAP", label: "MapBinStats\n48 Bins\n(S_dir, N_dir, Î¼_dir, Îº)", x: 500, y: 1700, width: 200, height: 80, fill: "#1e1e2e", stroke: "#6666aa", textColor: "#ffffff" },
            { id: "ST_PROC", label: "ProcessNoiseIW\nQ (22Ã—22)\n(rot, trans, vel, biases, dt, ex)", x: 750, y: 1700, width: 220, height: 80, fill: "#1e1e2e", stroke: "#6666aa", textColor: "#aaaaaa" },
            { id: "ST_MEAS", label: "MeasNoiseIW\nÎ£g, Î£a, Î£lidar\n(Per-sensor IW)", x: 1000, y: 1700, width: 180, height: 80, fill: "#1e1e2e", stroke: "#6666aa", textColor: "#aaaaaa" },
            { id: "ST_BUCKET", label: "BucketNoiseIW\nPer-bin Î»\n(LiDAR reliability)", x: 1220, y: 1700, width: 180, height: 80, fill: "#1e1e2e", stroke: "#6666aa", textColor: "#aaaaaa" },
            
            // Outputs
            { id: "OUT_STATE", label: "/gc/state\nnav_msgs/Odometry\n(6Ã—6 covariance)", x: 1850, y: 1700, width: 180, height: 60, fill: "#003366", stroke: "#4488ff", textColor: "#ffffff" },
            { id: "OUT_TRAJ", label: "/gc/trajectory\nnav_msgs/Path", x: 1850, y: 1780, width: 150, height: 50, fill: "#003366", stroke: "#4488ff", textColor: "#ffffff" },
            { id: "OUT_STATUS", label: "/gc/status\nJSON\n(odom/scan/imu counts)", x: 2030, y: 1700, width: 160, height: 60, fill: "#003366", stroke: "#4488ff", textColor: "#ffffff" },
            { id: "OUT_MANIFEST", label: "/gc/runtime_manifest\nJSON\n(backends, config)", x: 2030, y: 1780, width: 180, height: 60, fill: "#003366", stroke: "#4488ff", textColor: "#ffffff" },
            { id: "OUT_CERT", label: "/gc/certificate\nJSON\n(CertBundle)", x: 1850, y: 1850, width: 160, height: 50, fill: "#003366", stroke: "#4488ff", textColor: "#ffffff" },
            { id: "OUT_TUM", label: "Trajectory.txt\nTUM Format\n(For evaluation)", x: 2030, y: 1850, width: 160, height: 50, fill: "#003366", stroke: "#4488ff", textColor: "#ffffff" },
            { id: "OUT_NPZ", label: "Diagnostics.npz\nPer-Scan Metrics", x: 1850, y: 1920, width: 150, height: 50, fill: "#003366", stroke: "#4488ff", textColor: "#ffffff" },
            { id: "OUT_TF", label: "TF Broadcast\nodom_frame â†’ base_link", x: 2030, y: 1920, width: 180, height: 50, fill: "#006633", stroke: "#44ff88", textColor: "#ffffff" },
            
            // Audit
            { id: "WIRING", label: "wiring_auditor\nEnd-of-Run Summary\n(JSON)", x: 1850, y: 2030, width: 200, height: 60, fill: "#2d004d", stroke: "#aa00aa", textColor: "#ffffff" },
            
            // Legend
            { id: "L1", label: "Active/Processing", x: 1850, y: 650, width: 150, height: 30, fill: "#0f3d0f", stroke: "#00ff00", textColor: "#ffffff" },
            { id: "L2", label: "Unused/Dead-end", x: 1850, y: 700, width: 150, height: 30, fill: "#2a0e0e", stroke: "#ff4444", strokeDasharray: "5,5", textColor: "#ffcccc" },
            { id: "L3", label: "Closed-form (Exact)", x: 1850, y: 750, width: 150, height: 30, fill: "#2a4a2a", stroke: "#00ff00", textColor: "#ffffff" },
            { id: "L4", label: "Approximate (Frobenius)", x: 1850, y: 800, width: 150, height: 30, fill: "#4a3a1a", stroke: "#ff8800", textColor: "#ffffff" },
            { id: "L5", label: "Evidence", x: 1850, y: 850, width: 150, height: 30, fill: "#2a4a6a", stroke: "#00ccff", textColor: "#ffffff" },
            { id: "L6", label: "State Storage", x: 1850, y: 900, width: 150, height: 30, fill: "#1e1e2e", stroke: "#6666aa", textColor: "#ffffff" },
            { id: "L7", label: "Output", x: 1850, y: 950, width: 150, height: 30, fill: "#003366", stroke: "#4488ff", textColor: "#ffffff" },
            { id: "L8", label: "Hypothesis Merge", x: 1850, y: 1000, width: 150, height: 30, fill: "#4a2a2a", stroke: "#ff6666", textColor: "#ffffff" }
        ];

        // Draw nodes
        const nodeGroup = g.append("g").attr("class", "nodes");
        nodes.forEach(node => {
            const nodeG = nodeGroup.append("g")
                .attr("class", "node")
                .attr("id", node.id);
            
            nodeG.append("rect")
                .attr("x", node.x)
                .attr("y", node.y)
                .attr("width", node.width)
                .attr("height", node.height)
                .attr("rx", 5)
                .attr("ry", 5)
                .attr("fill", node.fill)
                .attr("stroke", node.stroke)
                .attr("stroke-width", 2)
                .attr("stroke-dasharray", node.strokeDasharray || null);
            
            const lines = node.label.split('\n');
            lines.forEach((line, i) => {
                nodeG.append("text")
                    .attr("x", node.x + node.width / 2)
                    .attr("y", node.y + 15 + (i * 12))
                    .attr("text-anchor", "middle")
                    .attr("fill", node.textColor || "#ffffff")
                    .attr("font-size", "9px")
                    .attr("font-family", "Arial")
                    .text(line);
            });
        });

        // Define edges
        const edges = [
            // Rosbag -> Sensor Hub (Active flows)
            { from: "BAG_ODOM", to: "ODOM_NORM", color: "#00ff00", width: 3, style: "solid" },
            { from: "BAG_MID_LIDAR", to: "LIVOX_CONV", color: "#00ff00", width: 3, style: "solid" },
            { from: "BAG_MID_IMU", to: "IMU_NORM", color: "#00ff00", width: 3, style: "solid" },
            
            // Dead-end flows
            { from: "BAG_VRPN", to: "DEAD_AUDIT", color: "#ff4444", width: 1.5, style: "dashed" },
            { from: "BAG_CAM_IMU", to: "DEAD_AUDIT", color: "#ff4444", width: 1.5, style: "dashed" },
            { from: "BAG_CAM_COLOR", to: "DEAD_AUDIT", color: "#ff4444", width: 1.5, style: "dashed" },
            { from: "BAG_CAM_DEPTH", to: "DEAD_AUDIT", color: "#ff4444", width: 1.5, style: "dashed" },
            { from: "BAG_AVIA_LIDAR", to: "DEAD_AUDIT", color: "#ff4444", width: 1.5, style: "dashed" },
            { from: "BAG_AVIA_IMU", to: "DEAD_AUDIT", color: "#ff4444", width: 1.5, style: "dashed" },
            
            // Sensor Hub -> Canonical
            { from: "ODOM_NORM", to: "CAN_ODOM", color: "#00ff00", width: 3, style: "solid" },
            { from: "LIVOX_CONV", to: "CAN_LIDAR", color: "#00ff00", width: 3, style: "solid" },
            { from: "IMU_NORM", to: "CAN_IMU", color: "#00ff00", width: 3, style: "solid" },
            { from: "DEAD_AUDIT", to: "CAN_DEAD", color: "#aa00aa", width: 2, style: "solid" },
            
            // Canonical -> Backend
            { from: "CAN_ODOM", to: "S09A", color: "#00ff00", width: 2, style: "solid", label: "Odom pose/cov" },
            { from: "CAN_LIDAR", to: "S01", color: "#00ff00", width: 3, style: "solid", label: "PointCloud2" },
            { from: "CAN_IMU", to: "IMU_BUF", color: "#00ff00", width: 3, style: "solid" },
            
            // IMU Buffer -> Pipeline
            { from: "IMU_BUF", to: "S03", color: "#66aa66", width: 2, style: "dashed", label: "Preintegration" },
            { from: "IMU_BUF", to: "S09B", color: "#66aa66", width: 2, style: "dashed", label: "Gravity" },
            { from: "IMU_BUF", to: "S09C", color: "#66aa66", width: 2, style: "dashed", label: "Gyro" },
            
            // Pipeline flow
            { from: "S01", to: "S02", color: "#00ff00", width: 2, style: "solid" },
            { from: "S02", to: "S03", color: "#00ff00", width: 2, style: "solid" },
            { from: "S03", to: "S04", color: "#00ff00", width: 2, style: "solid" },
            { from: "S04", to: "S05", color: "#00ff00", width: 2, style: "solid" },
            { from: "S05", to: "S06", color: "#00ff00", width: 2, style: "solid" },
            { from: "S06", to: "S07", color: "#00ff00", width: 2, style: "solid" },
            { from: "S07", to: "S08", color: "#00ff00", width: 2, style: "solid" },
            { from: "S08", to: "S09A", color: "#00ccff", width: 2, style: "solid" },
            { from: "S08", to: "S09B", color: "#00ccff", width: 2, style: "solid" },
            { from: "S08", to: "S09C", color: "#00ccff", width: 2, style: "solid" },
            { from: "S08", to: "S09D", color: "#00ccff", width: 2, style: "solid" },
            { from: "S09A", to: "S10", color: "#00ccff", width: 2, style: "solid" },
            { from: "S09B", to: "S10", color: "#00ccff", width: 2, style: "solid" },
            { from: "S09C", to: "S10", color: "#00ccff", width: 2, style: "solid" },
            { from: "S09D", to: "S10", color: "#00ccff", width: 2, style: "solid" },
            { from: "S10", to: "S11", color: "#00ff00", width: 2, style: "solid" },
            { from: "S11", to: "S12", color: "#00ff00", width: 2, style: "solid" },
            { from: "S12", to: "S13", color: "#00ff00", width: 2, style: "solid" },
            { from: "S13", to: "S14", color: "#00ff00", width: 2, style: "solid" },
            { from: "S14", to: "S15", color: "#ff6666", width: 3, style: "solid", label: "8Ã— parallel" },
            
            // State feedback loops
            { from: "ST_BELIEF", to: "S02", color: "#6666aa", width: 2, style: "dashed", label: "belief_prev" },
            { from: "ST_MAP", to: "S05", color: "#6666aa", width: 2, style: "dashed", label: "map_stats" },
            { from: "ST_PROC", to: "S02", color: "#6666aa", width: 2, style: "dashed", label: "Q (process noise)" },
            { from: "ST_MEAS", to: "S09B", color: "#6666aa", width: 1.5, style: "dashed", label: "Î£a" },
            { from: "ST_MEAS", to: "S09C", color: "#6666aa", width: 1.5, style: "dashed", label: "Î£g" },
            { from: "ST_BUCKET", to: "S05", color: "#6666aa", width: 2, style: "dashed", label: "Î» (reliability)" },
            
            // IW noise updates
            { from: "S08", to: "ST_BUCKET", color: "#ffaa00", width: 1.5, style: "dotted", label: "Translation residuals" },
            { from: "S09B", to: "ST_MEAS", color: "#ffaa00", width: 1.5, style: "dotted", label: "Accel IW update" },
            { from: "S09C", to: "ST_MEAS", color: "#ffaa00", width: 1.5, style: "dotted", label: "Gyro IW update" },
            { from: "S12", to: "ST_PROC", color: "#ffaa00", width: 1.5, style: "dotted", label: "Innovation residuals" },
            
            // Hypothesis merge -> State update
            { from: "S15", to: "ST_BELIEF", color: "#ff6666", width: 3, style: "solid" },
            { from: "S15", to: "ST_MAP", color: "#ff6666", width: 2, style: "solid", label: "Map update" },
            
            // State -> Outputs
            { from: "ST_BELIEF", to: "OUT_STATE", color: "#4488ff", width: 3, style: "solid" },
            { from: "ST_BELIEF", to: "OUT_TRAJ", color: "#4488ff", width: 3, style: "solid" },
            { from: "ST_BELIEF", to: "OUT_STATUS", color: "#4488ff", width: 2, style: "solid" },
            { from: "ST_BELIEF", to: "OUT_MANIFEST", color: "#4488ff", width: 2, style: "solid" },
            { from: "ST_BELIEF", to: "OUT_CERT", color: "#4488ff", width: 2, style: "solid" },
            { from: "ST_BELIEF", to: "OUT_TUM", color: "#4488ff", width: 2, style: "solid" },
            { from: "ST_BELIEF", to: "OUT_NPZ", color: "#4488ff", width: 2, style: "solid" },
            { from: "ST_BELIEF", to: "OUT_TF", color: "#44ff88", width: 2, style: "solid" },
            
            // Audit connections
            { from: "CAN_DEAD", to: "WIRING", color: "#aa00aa", width: 2, style: "solid" },
            { from: "OUT_STATUS", to: "WIRING", color: "#aa00aa", width: 2, style: "solid" },
            { from: "OUT_MANIFEST", to: "WIRING", color: "#aa00aa", width: 2, style: "solid" }
        ];

        // Helper to get node center
        function getNodeCenter(nodeId) {
            const node = nodes.find(n => n.id === nodeId);
            if (!node) return { x: 0, y: 0 };
            return {
                x: node.x + node.width / 2,
                y: node.y + node.height / 2
            };
        }

        // Draw edges
        const edgeGroup = g.append("g").attr("class", "edges");
        edges.forEach(edge => {
            const from = getNodeCenter(edge.from);
            const to = getNodeCenter(edge.to);
            
            const path = edgeGroup.append("path")
                .attr("d", `M ${from.x},${from.y} L ${to.x},${to.y}`)
                .attr("stroke", edge.color)
                .attr("stroke-width", edge.width)
                .attr("stroke-dasharray", edge.style === "dashed" ? "5,5" : edge.style === "dotted" ? "2,2" : null)
                .attr("fill", "none")
                .attr("class", "edge");
            
            if (edge.label) {
                const midX = (from.x + to.x) / 2;
                const midY = (from.y + to.y) / 2;
                edgeGroup.append("text")
                    .attr("x", midX)
                    .attr("y", midY - 5)
                    .attr("text-anchor", "middle")
                    .attr("class", "edge-label")
                    .text(edge.label);
            }
        });

        // Instructions
        const instructions = g.append("text")
            .attr("x", 50)
            .attr("y", height - 20)
            .attr("fill", "#888")
            .attr("font-size", "12px")
            .text("Scroll to zoom, drag to pan | Exact positioning with D3.js");
    </script>
</body>
</html>
